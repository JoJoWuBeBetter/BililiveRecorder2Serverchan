<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件管理控制台</title>
    <!-- 引入字体：补全了 WDXL Lubrifont SC 的引入 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=WDXL+Lubrifont+SC&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+QingKe+HuangYou&family=Noto+Sans+SC:wght@400;500;700&family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            /* RED ALERT 风格 - 赤色警戒版 */
            --hex-bg: #050000;
            --hex-panel: rgba(20, 5, 5, 0.92);
            --hex-border: #550000;

            /* 配色 */
            --primary-color: #ff3333;
            --secondary-color: #800000;
            --accent-orange: #ff9900;
            --alert-critical: #ff0000;

            --text-main: #ffeaea;
            --text-dim: #b35959;

            --grid-color: rgba(255, 51, 51, 0.15);

            --glow-strong: 0 0 10px rgba(255, 51, 51, 0.8), 0 0 20px rgba(255, 51, 51, 0.4);
            --glow-text: 0 0 2px rgba(255, 51, 51, 0.6);
            --glow-border: 0 0 8px rgba(255, 51, 51, 0.5);

            /* 基础字体栈 */
            --font-tech: 'Share Tech Mono', 'ZCOOL QingKe HuangYou', monospace;
            --font-header: 'Rajdhani', 'ZCOOL QingKe HuangYou', sans-serif;
        }

        * {
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--hex-bg);
        }

        body {
            font-family: var(--font-tech);
            background-color: var(--hex-bg);
            background-image:
                    radial-gradient(var(--grid-color) 1px, transparent 1px),
                    linear-gradient(rgba(255, 51, 51, 0.05) 1px, transparent 1px),
                    linear-gradient(90deg, rgba(255, 51, 51, 0.05) 1px, transparent 1px);
            background-size: 40px 40px, 20px 20px, 20px 20px;
            margin: 0;
            padding: 0;
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            text-shadow: 0 0 2px rgba(255, 0, 0, 0.4);
        }

        /* 文件名专用样式 - 强制使用 WDXL Lubrifont SC */
        .file-link {
            /* 字体栈：首选 WDXL -> 次选 站酷庆科黄油 -> 最后 黑体 */
            font-family: 'WDXL Lubrifont SC', 'ZCOOL QingKe HuangYou', 'Noto Sans SC', sans-serif !important;
            color: var(--text-main);
            text-decoration: none;
            font-weight: 500;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            display: inline-block;
        }

        .file-link:hover {
            color: var(--primary-color);
            text-shadow: var(--glow-text);
            transform: translateX(5px);
        }

        /* 顶部装饰条 */
        .top-bar {
            height: 40px;
            background: rgba(30, 5, 5, 0.9);
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            z-index: 10;
            box-shadow: 0 5px 15px rgba(255, 51, 51, 0.15);
        }

        .top-bar-left span {
            margin-right: 20px;
            color: var(--primary-color);
            font-weight: bold;
        }

        .top-bar-right {
            color: var(--accent-orange);
            font-weight: bold;
            animation: pulse-text 2s infinite;
        }

        @keyframes pulse-text {
            0% { opacity: 0.8; }
            50% { opacity: 1; text-shadow: 0 0 8px var(--accent-orange); }
            100% { opacity: 0.8; }
        }

        /* 主布局 */
        .main-layout {
            display: flex;
            height: calc(100vh - 40px);
            padding: 20px;
            gap: 20px;
        }

        /* 侧边栏 */
        .sidebar {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex-shrink: 0;
        }

        .panel {
            background: var(--hex-panel);
            border: 1px solid var(--primary-color);
            position: relative;
            backdrop-filter: none;
            box-shadow: 0 0 0 1px rgba(255, 51, 51, 0.1), 0 10px 30px rgba(0, 0, 0, 0.9);
            clip-path: polygon(
                    20px 0, 100% 0,
                    100% calc(100% - 20px), calc(100% - 20px) 100%,
                    0 100%, 0 20px
            );
            transition: all 0.2s ease;
        }

        .panel:hover {
            border-color: #ffcccc;
            box-shadow: var(--glow-border);
        }

        .panel::after {
            content: '';
            position: absolute;
            bottom: 5px; right: 25px;
            width: 40px; height: 4px;
            background: var(--primary-color);
            opacity: 0.5;
        }

        .panel-header {
            padding: 12px 18px;
            background: rgba(255, 51, 51, 0.15);
            color: var(--primary-color);
            font-size: 15px;
            font-weight: bold;
            border-bottom: 1px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            letter-spacing: 1px;
        }

        .panel-content {
            padding: 18px;
            display: flex;
            flex-direction: column;
        }

        /* 仪表盘 */
        .stat-row { margin-bottom: 18px; }
        .stat-label {
            font-size: 13px;
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-weight: bold;
        }
        .stat-bar-bg {
            height: 10px;
            background: #000;
            border: 1px solid var(--text-dim);
            position: relative;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255, 51, 51, 0.15) 5px, rgba(255, 51, 51, 0.15) 10px);
        }
        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            box-shadow: 0 0 10px var(--primary-color);
            width: 0%;
            position: relative;
        }
        .stat-bar-fill::after {
            content: '';
            position: absolute;
            right: 0; top: 0; bottom: 0;
            width: 2px;
            background: #fff;
            box-shadow: 0 0 5px #fff;
        }

        /* 键盘区 */
        .keyboard-mock {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px dashed var(--text-dim);
        }
        .key {
            height: 30px;
            border: 1px solid var(--text-dim);
            background: #0a0000;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            font-weight: bold;
            transition: 0.1s;
        }
        .key.active {
            background: var(--primary-color);
            color: #000;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-color);
        }
        .key.warning {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
            box-shadow: 0 0 5px rgba(255, 153, 0, 0.3);
        }

        /* 主内容区 */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            background: linear-gradient(90deg, rgba(255, 51, 51, 0.08), transparent);
        }

        h1 {
            color: var(--primary-color);
            font-family: var(--font-header);
            font-size: 32px;
            margin: 0;
            text-shadow: var(--glow-text);
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1::after {
            content: '_';
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .subtitle {
            font-size: 13px;
            color: var(--text-dim);
            margin-top: 5px;
            font-family: var(--font-tech);
        }
        .subtitle span { color: var(--accent-orange); }

        /* 按钮 */
        .button-group { display: flex; gap: 15px; }

        button {
            font-family: var(--font-header);
            background: rgba(20, 0, 0, 0.6);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 10px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 1px;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
        }

        button:hover {
            background: var(--primary-color);
            color: #000;
            box-shadow: var(--glow-strong);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: rgba(255, 51, 51, 0.15);
            border-width: 2px;
        }

        /* 表格区域 */
        .table-scroll-area {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--text-dim);
            background: rgba(5, 0, 0, 0.6);
            margin-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        th {
            position: sticky;
            top: 0;
            background: rgba(40, 5, 5, 0.95);
            color: var(--primary-color);
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid var(--primary-color);
            z-index: 5;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: var(--font-tech);
        }

        th[data-sort]:hover {
            background: rgba(255, 51, 51, 0.2);
            cursor: pointer;
            color: #fff;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 51, 51, 0.1);
            color: var(--text-main);
            transition: 0.1s;
        }

        tr:hover td {
            background: rgba(255, 51, 51, 0.15);
            color: #fff;
            border-bottom: 1px solid var(--primary-color);
        }

        tr.selected td {
            background: rgba(255, 51, 51, 0.25);
            color: #fff;
            text-shadow: 0 0 5px var(--primary-color);
            border-left: 4px solid var(--primary-color);
        }

        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            fill: currentColor;
            filter: drop-shadow(0 0 2px rgba(255, 51, 51, 0.5));
        }
        .icon-folder { color: var(--accent-orange); }
        .icon-file { color: var(--primary-color); opacity: 0.8; }
        .icon-audio { color: #ff00ff; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #050000; border-left: 1px solid var(--text-dim); }
        ::-webkit-scrollbar-thumb { background: var(--primary-color); border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: #fff; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: #0a0202;
            border: 2px solid var(--primary-color);
            margin: 8% auto;
            width: 650px;
            box-shadow: var(--glow-strong);
            position: relative;
            clip-path: polygon(
                    25px 0, 100% 0,
                    100% calc(100% - 25px), calc(100% - 25px) 100%,
                    0 100%, 0 25px
            );
        }

        .modal-header {
            background: rgba(255, 51, 51, 0.15);
            color: var(--primary-color);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            border-bottom: 1px solid var(--primary-color);
            font-size: 18px;
            letter-spacing: 1px;
        }

        .modal-body { padding: 30px; }
        .form-group { margin-bottom: 20px; }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-size: 13px;
            text-transform: uppercase;
            font-weight: bold;
        }

        input, textarea, select {
            width: 100%;
            background: #000;
            border: 1px solid var(--text-dim);
            color: #fff;
            padding: 12px;
            font-family: var(--font-tech);
            font-size: 15px;
            transition: 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.2);
            background: rgba(255, 51, 51, 0.05);
        }

        .modal-footer {
            padding: 20px 30px;
            text-align: right;
            border-top: 1px solid rgba(255, 51, 51, 0.2);
            background: rgba(10, 0, 0, 0.8);
        }

        .close-button {
            background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-dim); transition: 0.2s;
        }
        .close-button:hover { color: #fff; text-shadow: 0 0 5px #fff; }

        /* CRT Scanline Overlay */
        .crt::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(255, 0, 0, 0.01), rgba(255, 0, 0, 0.04));
            z-index: 999;
            background-size: 100% 3px, 4px 100%;
            pointer-events: none;
            opacity: 0.7;
        }

        /* Checkbox */
        input[type="checkbox"] {
            appearance: none;
            width: 16px; height: 16px;
            border: 1px solid var(--text-dim);
            display: inline-grid;
            place-content: center;
            background: #000;
            cursor: pointer;
        }
        input[type="checkbox"]::before {
            content: "";
            width: 8px; height: 8px;
            background: var(--primary-color);
            box-shadow: 0 0 5px var(--primary-color);
            transform: scale(0);
            transition: 0.1s;
        }
        input[type="checkbox"]:checked { border-color: var(--primary-color); }
        input[type="checkbox"]:checked::before { transform: scale(1); }

    </style>
</head>
<body class="crt">

<!-- 顶部状态栏 -->
<div class="top-bar">
    <div class="top-bar-left">
        <span>SYS.ROOT</span>
        <span>// RED_PROTOCOL V3.0</span>
        <span id="clock" style="color: #fff; margin-left: 30px;">00:00:00</span>
    </div>
    <div class="top-bar-right">
        <span>SECURITY LEVEL: </span>
        <span style="color: var(--primary-color); margin-left: 10px;">CRITICAL</span>
    </div>
</div>

<svg style="display: none;">
    <symbol id="icon-folder" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></symbol>
    <symbol id="icon-file" viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></symbol>
    <symbol id="icon-audio" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></symbol>
    <symbol id="icon-arrow-left" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></symbol>
    <symbol id="icon-cpu" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><line x1="9" y1="1" x2="9" y2="4"></line><line x1="15" y1="1" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="23"></line><line x1="15" y1="20" x2="15" y2="23"></line><line x1="20" y1="9" x2="23" y2="9"></line><line x1="1" y1="9" x2="4" y2="9"></line></symbol>
</svg>

<div class="main-layout">
    <!-- 左侧仪表盘 (System Stats) -->
    <aside class="sidebar">
        <!-- CPU/Memory Panel -->
        <div class="panel">
            <div class="panel-header">
                <span>SYSTEM_VITALS</span>
                <span>[DANGER]</span>
            </div>
            <div class="panel-content">
                <div class="stat-row">
                    <div class="stat-label"><span>CPU_CORE_0</span><span>89%</span></div>
                    <div class="stat-bar-bg"><div class="stat-bar-fill" style="width: 89%; animation-duration: 0.5s;"></div></div>
                </div>
                <div class="stat-row">
                    <div class="stat-label"><span>CPU_CORE_1</span><span>76%</span></div>
                    <div class="stat-bar-bg"><div class="stat-bar-fill" style="width: 76%; animation-duration: 0.8s;"></div></div>
                </div>
                <div class="stat-row">
                    <div class="stat-label"><span>MEM_LOAD</span><span>14.2GB</span></div>
                    <div class="stat-bar-bg"><div class="stat-bar-fill" style="width: 85%; animation-duration: 3s;"></div></div>
                </div>
                <div class="stat-row">
                    <div class="stat-label"><span>OVERHEAT</span><span>WARNING</span></div>
                    <div class="stat-bar-bg"><div class="stat-bar-fill" style="width: 100%; background: var(--accent-orange);"></div></div>
                </div>
            </div>
        </div>

        <!-- Network Panel -->
        <div class="panel" style="flex: 1;">
            <div class="panel-header">
                <span>NET_TRAFFIC</span>
                <span>UNSECURED</span>
            </div>
            <div class="panel-content" style="display: flex; flex-direction: column; height: 100%;">
                <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 15px; font-family: var(--font-tech); border-left: 2px solid var(--primary-color); padding-left: 10px;">
                    <div style="margin-bottom: 4px;">TARGET: 192.168.0.66</div>
                    <div style="margin-bottom: 4px;">PING: 102ms <span style="color: var(--accent-orange);">[LAG]</span></div>
                    <div style="margin-bottom: 4px;">UPLINK: 8.4 MB/s</div>
                    <div>DOWNLINK: 120.2 MB/s</div>
                </div>
                <div style="flex: 1; border: 1px dashed var(--text-dim); display: flex; align-items: flex-end; justify-content: space-around; padding-bottom: 5px; background: rgba(20,0,0,0.3);">
                    <!-- Fake Graph Bars -->
                    <div style="width: 12px; height: 30%; background: var(--secondary-color); opacity: 0.8;"></div>
                    <div style="width: 12px; height: 60%; background: var(--primary-color); opacity: 0.8;"></div>
                    <div style="width: 12px; height: 40%; background: var(--secondary-color); opacity: 0.8;"></div>
                    <div style="width: 12px; height: 90%; background: var(--primary-color); opacity: 0.9;"></div>
                    <div style="width: 12px; height: 50%; background: var(--secondary-color); opacity: 0.8;"></div>
                </div>

                <!-- 装饰性键盘 -->
                <div class="keyboard-mock">
                    <div class="key">ESC</div><div class="key">F1</div><div class="key">F2</div><div class="key">F3</div><div class="key">F4</div><div class="key warning">DEL</div>
                    <div class="key">TAB</div><div class="key active">Q</div><div class="key">W</div><div class="key">E</div><div class="key">R</div><div class="key">T</div>
                    <div class="key warning">CMD</div><div class="key">A</div><div class="key">S</div><div class="key">D</div><div class="key">F</div><div class="key">G</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- 主文件管理区 -->
    <main class="panel main-container">
        <div class="panel-header">
            <span>FILE_COMMAND_CENTER</span>
            <span>MOUNT: /restricted/data</span>
        </div>

        <div class="panel-content" style="display: flex; flex-direction: column; height: 100%; padding: 25px;">
            <header>
                <div>
                    <h1>/restricted/data</h1>
                    <div class="subtitle">ACCESS_LEVEL: <span style="color: var(--primary-color); font-weight: bold;">ADMINISTRATOR</span></div>
                </div>
                <div class="button-group">
                    <button id="back-button" class="btn-secondary" style="display: none;">
                        <svg class="icon"><use href="#icon-arrow-left"></use></svg>
                        BACK
                    </button>
                    <!-- 新增：跳转至任务控制台的入口 -->
                    <button onclick="window.location.href='/browser/tasks'" class="btn">
                        TASK_OPS
                    </button>

                    <button id="transcribe-file-button" class="btn-primary">
                        <svg class="icon"><use href="#icon-cpu"></use></svg>
                        INITIATE_PROCESS
                    </button>
                </div>
            </header>

            <div class="table-scroll-area">
                <table id="file-list">
                    <thead>
                    <tr>
                        <th style="width: 50px; text-align: center;"><input type="checkbox" id="select-all"></th>
                        <th style="width: 60px; text-align: center;" data-sort="type">TYPE</th>
                        <th data-sort="name">FILENAME</th>
                        <th style="width: 100px;" data-sort="ext">EXT</th>
                        <th style="width: 200px;" data-sort="last_modified">MODIFIED</th>
                        <th style="width: 120px;" data-sort="size">SIZE</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Files injected here -->
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 15px; font-size: 12px; color: var(--text-dim); text-align: right; display: flex; justify-content: flex-end; gap: 20px;">
                <span style="color: var(--accent-orange);">ALERTS: 3 ACTIVE</span>
                <span>CACHE: 98%</span>
                <span style="color: var(--primary-color);">SYSTEM: BUSY</span>
            </div>
        </div>
    </main>
</div>

<!-- Modal -->
<div id="transcription-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>> OVERRIDE_SEQUENCE_INIT</span>
            <button class="close-button">&times;</button>
        </div>

        <form id="transcription-form">
            <div class="modal-body">
                <div id="file-path-group" class="form-group">
                    <label for="file-path">TARGET_VECTORS [BATCH]</label>
                    <textarea id="file-path" name="file_path" rows="4" readonly></textarea>
                </div>

                <div id="single-file-options">
                    <div class="form-group">
                        <label for="engine-model-type">CORE_ENGINE</label>
                        <input type="text" id="engine-model-type" name="engine_model_type" value="16k_zh_large">
                    </div>
                    <div style="display: flex; gap: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="channel-num">CHANNELS</label>
                            <input type="number" id="channel-num" name="channel_num" value="1">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="res-text-format">OUTPUT_FMT</label>
                            <input type="number" id="res-text-format" name="res_text_format" value="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="hotword-id">DICTIONARY_ID</label>
                        <input type="text" id="hotword-id" name="hotword_id" placeholder="NULL">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="submit" class="btn-primary">EXECUTE_FORCE >></button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Clock
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', {hour12: false});
        }, 1000);

        const fileList = document.getElementById("file-list").getElementsByTagName('tbody')[0];
        const selectAll = document.getElementById("select-all");
        const backButton = document.getElementById("back-button");
        const tableHeaders = document.querySelectorAll("th[data-sort]");
        const transcribeFileButton = document.getElementById("transcribe-file-button");
        const modal = document.getElementById("transcription-modal");
        const form = document.getElementById("transcription-form");
        const filePathInput = document.getElementById("file-path");
        const closeButton = document.querySelector(".close-button");

        let currentPath = '';
        let sortColumn = null;
        let sortDirection = 'asc';
        const selectedItems = new Map();
        let selectedFilePaths = [];

        // Mock data
        const mockFiles = [
            { name: "七区日志", is_directory: true, size: 0, last_modified: "2023-10-27T10:00:00", path: "/Sector_7_Logs" },
            { name: "黑匣子数据", is_directory: true, size: 0, last_modified: "2023-10-26T15:30:00", path: "/Black_Box_Data" },
            { name: "审讯录音_004.mp3", is_directory: false, size: 15482880, last_modified: "2023-10-25T09:15:00", path: "/interrogation_rec_004.mp3" },
            { name: "加密信号.wav", is_directory: false, size: 45000000, last_modified: "2023-10-24T14:20:00", path: "/encrypted_signal.wav" },
            { name: "自毁代码.txt", is_directory: false, size: 1024, last_modified: "2023-10-24T10:00:00", path: "/kill_switch_code.txt" },
            { name: "核心转储.json", is_directory: false, size: 256, last_modified: "2023-10-23T11:00:00", path: "/core_dump.json" }
        ];

        function getIconHtml(isDirectory, filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const audioExts = ['mp3', 'wav', 'flac', 'aac', 'm4a', 'ogg'];

            if (isDirectory) {
                return `<svg class="icon icon-folder"><use href="#icon-folder"></use></svg>`;
            } else if (audioExts.includes(ext)) {
                return `<svg class="icon icon-audio"><use href="#icon-audio"></use></svg>`;
            } else {
                return `<svg class="icon icon-file"><use href="#icon-file"></use></svg>`;
            }
        }

        function loadFiles(path) {
            const safePath = path || '';
            const fetchUrl = `/files/?path=${encodeURIComponent(safePath)}`;

            // 使用 try-catch 包裹 fetch 调用，以兼容 blob 环境和真实服务器环境
            // 优先尝试真实请求，失败后才回退到模拟数据
            try {
                fetch(fetchUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        processFiles(data, safePath);
                    })
                    .catch(err => {
                        console.warn("Fetch failed, switching to Mock Data:", err);
                        // 仅在根目录加载模拟数据，避免子目录显示错误
                        if (!safePath) {
                            processFiles(mockFiles, safePath);
                        } else {
                            processFiles([], safePath);
                        }
                    });
            } catch (e) {
                // 捕获同步错误（如 Blob URL 中的相对路径解析错误）
                console.warn("Synchronous fetch error, switching to Mock Data:", e);
                if (!safePath) {
                    processFiles(mockFiles, safePath);
                } else {
                    processFiles([], safePath);
                }
            }
        }

        function processFiles(data, path) {
            if (sortColumn) {
                data.sort((a, b) => {
                    let aValue, bValue;
                    switch (sortColumn) {
                        case 'name': aValue = a.name; bValue = b.name; break;
                        case 'ext': aValue = a.is_directory ? '' : a.name.split('.').pop(); bValue = b.is_directory ? '' : b.name.split('.').pop(); break;
                        case 'last_modified': aValue = new Date(a.last_modified); bValue = new Date(b.last_modified); break;
                        case 'size': aValue = a.size; bValue = b.size; break;
                        case 'type': aValue = a.is_directory ? 'directory' : 'file'; bValue = b.is_directory ? 'directory' : 'file'; break;
                        default: return 0;
                    }
                    if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                    if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            } else {
                data.sort((a, b) => {
                    if (a.is_directory !== b.is_directory) return a.is_directory ? -1 : 1;
                    return a.name.localeCompare(b.name);
                });
            }

            fileList.innerHTML = '';
            if (data.length === 0 && path) {
                const row = fileList.insertRow();
                row.innerHTML = `<td colspan="6" style="text-align:center; padding: 30px; color: var(--text-dim); border: 1px dashed var(--text-dim);">[ SECTOR_EMPTY ]</td>`;
            } else {
                data.forEach(file => {
                    const row = fileList.insertRow();
                    const extension = file.is_directory ? '<DIR>' : file.name.split('.').pop().toUpperCase();
                    const iconHtml = getIconHtml(file.is_directory, file.name);

                    row.dataset.path = file.path;
                    row.dataset.isDirectory = file.is_directory;
                    row.dataset.name = file.name;

                    row.innerHTML = `
                            <td style="text-align: center;"><input type="checkbox" class="file-checkbox"></td>
                            <td style="text-align: center;">${iconHtml}</td>
                            <td><a href="#" class="file-link" data-path="${file.path}" data-is-directory="${file.is_directory}">${file.name}</a></td>
                            <td><span style="color: var(--text-dim); font-size: 11px;">${extension}</span></td>
                            <td style="color: var(--text-dim); font-size:12px;">${new Date(file.last_modified).toLocaleString()}</td>
                            <td style="font-family: var(--font-tech);">${file.is_directory ? '--' : formatSize(file.size)}</td>
                        `;
                });
            }
            currentPath = path;
            backButton.style.display = path ? 'inline-flex' : 'none';
            document.querySelector('h1').innerText = path || '/restricted/data';

            selectedItems.clear();
            selectedFilePaths = [];
            selectAll.checked = false;
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        fileList.addEventListener("click", function (e) {
            const row = e.target.closest('tr');
            if (!row) return;

            const link = row.querySelector('a[data-path]');
            if (!link) return;

            const path = link.dataset.path;
            const isDirectory = link.dataset.isDirectory === 'true';

            if (e.target.closest('a')) {
                e.preventDefault();
                if (isDirectory) {
                    loadFiles(path);
                }
                return;
            }

            const checkbox = row.querySelector('.file-checkbox');
            const newState = e.target.classList.contains('file-checkbox') ? checkbox.checked : !checkbox.checked;
            toggleSelection(row, newState);
        });

        backButton.addEventListener("click", function () {
            if (!currentPath) return;
            const separator = currentPath.includes('\\') ? '\\' : '/';
            const parentPath = currentPath.substring(0, currentPath.lastIndexOf(separator));
            loadFiles(parentPath);
        });

        selectAll.addEventListener("change", function () {
            const checkboxes = fileList.querySelectorAll(".file-checkbox");
            const shouldSelectAll = selectAll.checked;

            checkboxes.forEach(checkbox => {
                checkbox.checked = shouldSelectAll;
                const row = checkbox.closest('tr');
                toggleSelection(row, shouldSelectAll, true);
            });

            updateSelectAllState();
        });

        tableHeaders.forEach(header => {
            header.addEventListener("click", function () {
                const newSortColumn = header.dataset.sort;
                if (sortColumn === newSortColumn) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = newSortColumn;
                    sortDirection = 'asc';
                }
                loadFiles(currentPath);
            });
        });

        function toggleSelection(row, shouldSelect, skipSelectAllUpdate = false) {
            if (!row) return;
            const path = row.dataset.path;
            const isDirectory = row.dataset.isDirectory === 'true';
            const name = row.dataset.name;

            if (shouldSelect) {
                selectedItems.set(path, {path, isDirectory, name});
                row.classList.add('selected');
            } else {
                selectedItems.delete(path);
                row.classList.remove('selected');
            }

            const checkbox = row.querySelector('.file-checkbox');
            if (checkbox) checkbox.checked = shouldSelect;
            if (!skipSelectAllUpdate) {
                updateSelectAllState();
            }
        }

        function updateSelectAllState() {
            const checkboxes = fileList.querySelectorAll('.file-checkbox');
            if (!checkboxes.length) {
                selectAll.checked = false;
                return;
            }
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            selectAll.checked = checkedCount === checkboxes.length;
        }

        function getSelectedFiles() {
            return Array.from(selectedItems.values()).filter(item => !item.isDirectory);
        }

        transcribeFileButton.addEventListener("click", function () {
            const files = getSelectedFiles();
            if (!files.length) {
                alert("[SYSTEM_ALERT] SELECT_TARGET_FILE > 0");
                return;
            }

            selectedFilePaths = files.map(item => item.path);
            filePathInput.value = selectedFilePaths.join('\n');
            modal.style.display = "block";
        });

        closeButton.addEventListener("click", () => {
            modal.style.display = "none";
        });

        window.addEventListener("click", (event) => {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        });

        form.addEventListener("submit", function (e) {
            e.preventDefault();
            const url = '/tasks/multi-file-transcription';
            const filePaths = selectedFilePaths.length
                ? selectedFilePaths
                : filePathInput.value.split('\n').map(p => p.trim()).filter(Boolean);

            const body = {
                file_paths: filePaths,
                engine_model_type: document.getElementById('engine-model-type').value,
                channel_num: parseInt(document.getElementById('channel-num').value, 10),
                res_text_format: parseInt(document.getElementById('res-text-format').value, 10),
                hotword_id: document.getElementById('hotword-id').value || null
            };

            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerText;
            submitBtn.innerText = 'PROCESSING...';
            submitBtn.disabled = true;

            // 同样使用 try-catch 包裹提交逻辑
            try {
                fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        alert(`> SUCCESS: ${data.length} TASKS INITIATED.`);
                        modal.style.display = "none";
                    })
                    .catch(error => {
                        console.warn('Submission failed, attempting fallback demo:', error);
                        setTimeout(() => {
                            alert(`[DEMO_MODE] SUCCESS: ${filePaths.length} TASKS INITIATED.\n(Simulated response due to: ${error.message})`);
                            modal.style.display = "none";
                        }, 500);
                    })
                    .finally(() => {
                        submitBtn.innerText = originalBtnText;
                        submitBtn.disabled = false;
                    });
            } catch (e) {
                // 捕获同步错误
                console.warn("Synchronous submit error:", e);
                setTimeout(() => {
                    alert(`[DEMO_MODE] SUCCESS: ${filePaths.length} TASKS INITIATED.\n(Simulated response)`);
                    modal.style.display = "none";
                    submitBtn.innerText = originalBtnText;
                    submitBtn.disabled = false;
                }, 500);
            }
        });

        // Initial load
        loadFiles('');
    });
</script>
</body>
</html>